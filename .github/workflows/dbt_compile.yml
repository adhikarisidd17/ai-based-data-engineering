name: DBT Compile Check 

on:
  pull_request:
    paths:
      - 'models/**/*.sql'

jobs:
  dbt-compile:
    runs-on: ubuntu-latest
    permissions:
      id-token: write          # Allow OIDC token exchange
      contents: read          # Read repo contents

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to GCP via Workload Identity
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: 'projects/70883618164/locations/global/workloadIdentityPools/workload-identity-pool-nonprod/providers/gha-dbt-nonprod'
          service_account: 'svc-gha-dbt@ab73-np-bica-wif-82db.iam.gserviceaccount.com'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "export PATH=\"$HOME/.local/bin:$PATH\"" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          poetry install

      - name: Install dbt and BigQuery adapter
        run: |
          poetry run pip install dbt-core dbt-bigquery

      - name: Install DBT dependencies
        run: |
          poetry run dbt deps

      - name: dbt compile
        run: |
            poetry run dbt compile --profiles-dir .